<div class="space-y-6">
  <div id="q8-notifications" class="q8-toast-stack"></div>

  <!-- How it works -->
  <div class="question-card space-y-3">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h4 class="font-semibold text-heading">&#x1F393; How this simulator works</h4>
        <p class="small-caption text-muted">Follow the three-stage RLHF loop: collect feedback, train a reward model, then optimise with PPO.</p>
      </div>
      <div class="flex items-center gap-2 text-xs">
        <button id="q8-tour-btn" class="btn-soft">&#x25B6; Start guided tour</button>
        <button id="q8-how-toggle" class="btn-soft" aria-expanded="true">Hide</button>
      </div>
    </div>
    <div id="q8-how-body" class="space-y-3">
      <ol class="list-decimal list-inside text-sm text-heading space-y-1">
        <li><strong>Stage 1 &ndash; Data collection:</strong> Compare responses A and B five times. We track progress and advance automatically.</li>
        <li><strong>Stage 2 &ndash; Reward model:</strong> Train a preference predictor with the collected comparisons.</li>
        <li><strong>Stage 3 &ndash; RL optimisation:</strong> Run PPO training and evaluate alignment metrics.</li>
      </ol>
      <div class="panel panel-neutral p-3 text-xs space-y-1">
        <div class="font-semibold">Controls</div>
        <ul class="list-disc list-inside space-y-0.5">
          <li><strong>💡 Try training examples:</strong> Loads a curated prompt + responses and simulates feedback.</li>
          <li><strong>&#x1F504; Reset progress:</strong> Clears state and returns to Stage 1.</li>
          <li><strong>Stage cards:</strong> Manually switch stages whenever you want to inspect them.</li>
        </ul>
      </div>
      <p class="small-caption text-muted">All numbers are illustrative and computed locally in your browser.</p>
    </div>
  </div>

  <!-- Stage picker -->
  <div class="question-card space-y-3">
    <div class="flex items-center justify-between text-sm text-heading">
      <span class="font-medium">&#x1F504; Select RLHF training stage</span>
      <span id="q8-overall-progress" class="small-caption text-muted">Stage 1/3</span>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3" id="q8-stage-picker">
      <label class="question-strategy" data-tone="emerald">
        <input type="radio" name="q8-stage" value="collection" checked>
        <div class="stacked-card space-y-1">
          <span class="font-medium text-heading">Data collection</span>
          <p class="small-caption text-muted">Gather human preferences (Step 1)</p>
        </div>
      </label>
      <label class="question-strategy" data-tone="purple">
        <input type="radio" name="q8-stage" value="reward">
        <div class="stacked-card space-y-1">
          <span class="font-medium text-heading">Reward modelling</span>
          <p class="small-caption text-muted">Train the preference predictor (Step 2)</p>
        </div>
      </label>
      <label class="question-strategy" data-tone="amber">
        <input type="radio" name="q8-stage" value="optimize">
        <div class="stacked-card space-y-1">
          <span class="font-medium text-heading">RL optimisation</span>
          <p class="small-caption text-muted">Fine-tune policy with PPO (Step 3)</p>
        </div>
      </label>
    </div>
  </div>

  <!-- Stage overview chips -->
  <div class="question-card">
    <div class="grid md:grid-cols-3 gap-4 text-sm">
      <div class="panel panel-neutral p-3 text-center space-y-2">
        <div id="q8-stage1-icon" class="q8-stage-icon" data-state="idle">1</div>
        <div class="font-semibold">Feedback collected</div>
        <div id="q8-stage1-status" class="q8-stage-status small-caption text-muted" data-state="idle">Awaiting comparisons</div>
      </div>
      <div class="panel panel-neutral p-3 text-center space-y-2">
        <div id="q8-stage2-icon" class="q8-stage-icon" data-state="idle">2</div>
        <div class="font-semibold">Reward model</div>
        <div id="q8-stage2-status" class="q8-stage-status small-caption text-muted" data-state="idle">Training pending</div>
      </div>
      <div class="panel panel-neutral p-3 text-center space-y-2">
        <div id="q8-stage3-icon" class="q8-stage-icon" data-state="idle">3</div>
        <div class="font-semibold">RL optimisation</div>
        <div id="q8-stage3-status" class="q8-stage-status small-caption text-muted" data-state="idle">Not started</div>
      </div>
    </div>
  </div>

  <!-- Quick actions -->
  <div class="question-card flex flex-wrap items-center gap-3">
    <button id="q8-example-btn" class="btn-soft text-xs">💡 Try training example</button>
    <button id="q8-reset-btn" class="btn-soft text-xs">&#x1F504; Reset progress</button>
  </div>

  <!-- Stage 1: Data collection -->
  <div id="q8-collection-panel" class="question-card space-y-4">
    <div class="flex items-center justify-between gap-3">
      <h4 class="font-medium text-heading">📝 Stage 1 &middot; Collect preference data</h4>
      <span class="chip chip-info text-xs">Compare responses A/B five times</span>
    </div>

    <div class="panel panel-neutral p-4 space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold text-heading text-sm" id="q8-current-prompt">Prompt will appear here</div>
          <p class="small-caption text-muted">Vote for the response you prefer. Five votes advance you to the reward model.</p>
        </div>
        <div class="text-right">
          <div class="font-mono text-heading" id="q8-feedback-count">0 / 5 comparisons</div>
          <div class="q8-progress"><div id="q8-feedback-progress"></div></div>
        <div class="small-caption text-muted" id="q8-example-counter">1 of 5</div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="panel panel-info p-3 q8-response-card">
          <div class="flex items-start justify-between gap-2">
            <h5 class="font-medium text-heading">Response A</h5>
            <span class="chip chip-info text-xs" id="q8-response-a-style">Style</span>
          </div>
          <div id="q8-response-a" class="q8-response-text"></div>
          <p id="q8-response-a-meta" class="small-caption text-muted"></p>
          <button id="q8-vote-a" class="btn-soft text-xs w-full">Prefer this</button>
        </div>
        <div class="panel panel-success p-3 q8-response-card">
          <div class="flex items-start justify-between gap-2">
            <h5 class="font-medium text-heading">Response B</h5>
            <span class="chip chip-success text-xs" id="q8-response-b-style">Style</span>
          </div>
          <div id="q8-response-b" class="q8-response-text"></div>
          <p id="q8-response-b-meta" class="small-caption text-muted"></p>
          <button id="q8-vote-b" class="btn-soft text-xs w-full">Prefer this</button>
        </div>
      </div>

      <div class="panel panel-neutral p-3 text-sm" id="q8-vote-text">Make your first preference comparison to begin.</div>
      <div class="small-caption text-muted" id="q8-vote-result"></div>
    </div>
  </div>

  <!-- Stage 2: Reward model -->
  <div id="q8-reward-panel" class="question-card space-y-4 hidden">
    <div class="flex items-center justify-between gap-3">
      <h4 class="font-medium text-heading">🧠 Stage 2 &middot; Train reward model</h4>
      <span class="chip chip-accent text-xs">Requires collected comparisons</span>
    </div>
    <div class="panel panel-neutral p-4 space-y-4">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="panel panel-accent p-3 space-y-1">
          <h6 class="font-medium text-heading">Training data</h6>
          <div class="text-sm text-body">📊 Preference pairs: <span id="q8-training-pairs">0</span></div>
          <div class="text-sm text-body">🎯 Quality annotations: <span id="q8-quality-data">0</span></div>
          <div class="text-sm text-body">📈 Training accuracy: <span id="q8-model-accuracy">0%</span></div>
        </div>
        <div class="panel panel-warning p-3 space-y-1">
          <h6 class="font-medium text-heading">Reward predictions</h6>
          <div id="q8-reward-examples" class="text-sm space-y-1">
            <div>High quality: <span class="font-mono text-success">+0.85</span></div>
            <div>Medium quality: <span class="font-mono text-warning">+0.42</span></div>
            <div>Low quality: <span class="font-mono text-danger">-0.31</span></div>
          </div>
        </div>
      </div>
      <div class="panel panel-neutral p-3 text-sm space-y-2">
        <button id="q8-train-reward" class="btn-soft">🧠 Train reward model</button>
        <div id="q8-reward-status" class="small-caption text-muted">Click to start reward-model training.</div>
      </div>
    </div>
  </div>

  <!-- Stage 3: RL optimisation -->
  <div id="q8-optimize-panel" class="question-card space-y-4 hidden">
    <div class="flex items-center justify-between gap-3">
      <h4 class="font-medium text-heading">🎯 Stage 3 &middot; Reinforcement learning optimisation</h4>
      <span class="chip chip-warning text-xs">Simulated PPO loop</span>
    </div>
    <div class="panel panel-neutral p-4 space-y-4">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="panel panel-warning p-3 space-y-2">
          <div class="flex items-start justify-between gap-2">
            <h6 class="font-medium text-heading">Policy updates</h6>
            <button id="q8-policy-help" class="btn-soft text-xs">What do these mean?</button>
          </div>
          <div class="text-sm text-body">
            <div>Episodes: <span id="q8-episodes">0</span></div>
            <div>Avg reward: <span id="q8-avg-reward">0.00</span></div>
            <div>Learning rate: <span class="font-mono">1e-5</span></div>
          </div>
          <div id="q8-policy-help-body" class="panel panel-warning p-2 hidden text-xs">
            <ul class="list-disc list-inside space-y-0.5">
              <li><strong>Episodes:</strong> RL training iterations.</li>
              <li><strong>Avg reward:</strong> Reward model score for latest outputs.</li>
              <li><strong>Learning rate:</strong> Step size for PPO updates.</li>
            </ul>
          </div>
        </div>
        <div class="panel panel-info p-3 q8-response-card">
          <div class="flex items-start justify-between gap-2">
            <h6 class="font-medium text-heading">Performance</h6>
            <button id="q8-performance-help" class="btn-soft text-xs">What do these mean?</button>
          </div>
          <div class="text-sm text-body">
            <div>Helpfulness: <span id="q8-helpfulness">65%</span></div>
            <div>Safety: <span id="q8-safety">78%</span></div>
            <div>Coherence: <span id="q8-coherence">82%</span></div>
          </div>
          <div id="q8-performance-help-body" class="panel panel-info p-2 hidden text-xs">
            <ul class="list-disc list-inside space-y-0.5">
              <li><strong>Helpfulness:</strong> How often the model answers the prompt well.</li>
              <li><strong>Safety:</strong> Likelihood of avoiding harmful content.</li>
              <li><strong>Coherence:</strong> Structure and clarity of responses.</li>
            </ul>
          </div>
        </div>
        <div class="panel panel-success p-3 q8-response-card">
          <div class="flex items-start justify-between gap-2">
            <h6 class="font-medium text-heading">Alignment metrics</h6>
            <button id="q8-alignment-help" class="btn-soft text-xs">What do these mean?</button>
          </div>
          <div class="text-sm text-body">
            <div>Preference match: <span id="q8-preference">71%</span></div>
            <div>Alignment score: <span id="q8-alignment">68%</span></div>
            <div>Robustness: <span id="q8-robustness">75%</span></div>
          </div>
          <div id="q8-alignment-help-body" class="panel panel-success p-2 hidden text-xs">
            <ul class="list-disc list-inside space-y-0.5">
              <li><strong>Preference match:</strong> Agreement with human rankings.</li>
              <li><strong>Alignment:</strong> Combined helpfulness &times; safety.</li>
              <li><strong>Robustness:</strong> Stability across prompts.</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap gap-3">
        <button id="q8-run-ppo" class="btn-soft">🚀 Run PPO training</button>
        <button id="q8-evaluate" class="btn-soft">📊 Evaluate model</button>
      </div>
      <div id="q8-rl-status" class="small-caption text-muted">Run PPO training to update the metrics.</div>
    </div>
  </div>

  <!-- Explanations -->
  <div id="q8-explanation" class="panel panel-warning p-4 text-sm">
    RLHF starts with human comparisons, fits a reward model to those preferences, then tunes the base model with reinforcement learning so it consistently produces human-aligned answers.
  </div>
</div>
