<style>
  #q47-interactive .q47-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  #q47-interactive .q47-row-label {
    width: 11rem;
    text-align: right;
    font-size: 0.75rem;
    font-weight: 500;
    letter-spacing: 0.015em;
    color: var(--color-muted);
  }
  #q47-interactive .q47-row-content {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.35rem;
  }
  #q47-interactive .q47-range {
    width: 100%;
    accent-color: var(--color-path-foundations-strong);
  }
  #q47-interactive .q47-token {
    --q47-token-opacity: 0.65;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.75rem;
    height: 1.75rem;
    border-radius: 0.6rem;
    border: 1px solid color-mix(in srgb, var(--color-border-subtle) 70%, transparent 30%);
    background: color-mix(in srgb, var(--color-card) 92%, transparent 8%);
    color: var(--color-heading);
    font-size: 0.75rem;
    font-family: "JetBrains Mono", "Fira Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    transition: background-color .25s ease, border-color .25s ease, color .25s ease, opacity .2s ease;
    opacity: var(--q47-token-opacity);
  }
  html.dark #q47-interactive .q47-token {
    background: color-mix(in srgb, var(--color-card) 80%, transparent 20%);
    border-color: color-mix(in srgb, var(--color-border) 78%, transparent 22%);
    color: var(--color-body);
  }
  #q47-interactive .q47-token--context {
    --q47-token-opacity: var(--q47-token-active-opacity, 1);
    background: color-mix(in srgb, var(--color-path-foundations-soft) 80%, transparent 20%);
    border-color: color-mix(in srgb, var(--color-path-foundations-border) 85%, transparent 15%);
    color: var(--color-path-foundations-text);
  }
  html.dark #q47-interactive .q47-token--context {
    background: color-mix(in srgb, var(--color-path-foundations-soft) 55%, transparent 45%);
  }
  #q47-interactive .q47-token--faded {
    --q47-token-opacity: 0.22;
  }
  #q47-interactive .q47-token--clipped {
    background-image: repeating-linear-gradient(45deg,
      color-mix(in srgb, var(--color-border-subtle) 65%, transparent 35%) 0px,
      color-mix(in srgb, var(--color-border-subtle) 65%, transparent 35%) 4px,
      color-mix(in srgb, var(--color-border) 85%, transparent 15%) 4px,
      color-mix(in srgb, var(--color-border) 85%, transparent 15%) 8px);
    border-style: dashed;
  }
  html.dark #q47-interactive .q47-token--clipped {
    background-image: repeating-linear-gradient(45deg,
      color-mix(in srgb, var(--color-border) 65%, transparent 35%) 0px,
      color-mix(in srgb, var(--color-border) 65%, transparent 35%) 4px,
      color-mix(in srgb, var(--color-border-subtle) 70%, transparent 30%) 4px,
      color-mix(in srgb, var(--color-border-subtle) 70%, transparent 30%) 8px);
  }
  #q47-interactive .q47-token--boundary {
    outline: 2px solid var(--color-path-foundations-strong);
    outline-offset: 1px;
  }

  #q47-interactive .q47-impact-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.1rem 0.65rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid color-mix(in srgb, var(--color-border-subtle) 70%, transparent 30%);
    background: color-mix(in srgb, var(--color-card) 88%, transparent 12%);
    color: var(--color-heading);
    transition: background-color .25s ease, border-color .25s ease, color .25s ease;
  }
  html.dark #q47-interactive .q47-impact-badge {
    color: var(--color-body);
    background: color-mix(in srgb, var(--color-card) 70%, transparent 30%);
    border-color: color-mix(in srgb, var(--color-border) 70%, transparent 30%);
  }
  #q47-interactive .q47-impact-badge[data-level="excellent"] {
    background: color-mix(in srgb, var(--panel-success-bg) 85%, transparent 15%);
    border-color: var(--panel-success-border);
    color: var(--panel-success-heading);
  }
  #q47-interactive .q47-impact-badge[data-level="good"] {
    background: color-mix(in srgb, var(--panel-info-bg) 85%, transparent 15%);
    border-color: var(--panel-info-border);
    color: var(--panel-info-heading);
  }
  #q47-interactive .q47-impact-badge[data-level="limited"] {
    background: color-mix(in srgb, var(--panel-warning-bg) 85%, transparent 15%);
    border-color: var(--panel-warning-border);
    color: var(--panel-warning-heading);
  }
  #q47-interactive .q47-impact-badge[data-level="poor"] {
    background: color-mix(in srgb, var(--color-path-scaling-soft) 75%, transparent 25%);
    border-color: var(--color-path-scaling-border);
    color: var(--color-path-scaling-text);
  }

  #q47-interactive .q47-impact-meter {
    position: relative;
    width: 100%;
    height: 0.5rem;
    border-radius: 9999px;
    border: 1px solid color-mix(in srgb, var(--color-border-subtle) 70%, transparent 30%);
    background: color-mix(in srgb, var(--color-card) 92%, transparent 8%);
    overflow: hidden;
  }
  html.dark #q47-interactive .q47-impact-meter {
    background: color-mix(in srgb, var(--color-card) 72%, transparent 28%);
    border-color: color-mix(in srgb, var(--color-border) 70%, transparent 30%);
  }
  #q47-interactive .q47-impact-meter-fill {
    width: 0;
    height: 100%;
    border-radius: inherit;
    background: var(--color-path-foundations-strong);
    transition: width .3s ease, background-color .3s ease;
  }
  #q47-interactive .q47-impact-meter-fill[data-level="excellent"] { background: var(--panel-success-border-strong); }
  #q47-interactive .q47-impact-meter-fill[data-level="good"] { background: var(--panel-info-border-strong); }
  #q47-interactive .q47-impact-meter-fill[data-level="limited"] { background: var(--panel-warning-border-strong); }
  #q47-interactive .q47-impact-meter-fill[data-level="poor"] { background: var(--color-path-scaling-strong); }

  #q47-interactive .q47-heatmap-wrapper {
    margin-top: 0.5rem;
    display: grid;
    gap: 0.35rem;
    font-size: 0.75rem;
    color: var(--color-muted);
  }
  #q47-interactive .q47-heatmap-title {
    font-weight: 600;
    color: var(--color-path-foundations-text);
  }
  #q47-interactive .q47-heatmap-grid {
    display: grid;
    gap: 2px;
    padding: 0.45rem;
    border-radius: 0.75rem;
    background: color-mix(in srgb, var(--color-card) 86%, transparent 14%);
    border: 1px solid color-mix(in srgb, var(--color-border-subtle) 70%, transparent 30%);
  }
  html.dark #q47-interactive .q47-heatmap-grid {
    background: color-mix(in srgb, var(--color-card) 70%, transparent 30%);
    border-color: color-mix(in srgb, var(--color-border) 70%, transparent 30%);
  }
  #q47-interactive .q47-heatmap-cell {
    width: 100%;
    height: 20px;
    border-radius: 0.3rem;
    transition: transform .2s ease;
  }
  #q47-interactive .q47-heatmap-cell:hover {
    transform: scale(1.05);
  }
  #q47-interactive .q47-heatmap-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem;
    border-radius: 0.75rem;
    border: 1px dashed color-mix(in srgb, var(--color-border-subtle) 70%, transparent 30%);
    background: color-mix(in srgb, var(--color-card) 92%, transparent 8%);
    color: var(--color-muted);
    font-size: 0.75rem;
    text-align: center;
  }
  html.dark #q47-interactive .q47-heatmap-placeholder {
    border-color: color-mix(in srgb, var(--color-border) 70%, transparent 30%);
    background: color-mix(in srgb, var(--color-card) 70%, transparent 30%);
    color: var(--color-muted-soft);
  }

  #q47-interactive .q47-sparkline svg {
    display: block;
  }
  #q47-interactive .q47-sparkline circle {
    stroke: color-mix(in srgb, var(--color-card) 30%, transparent 70%);
    stroke-width: 2;
  }

  #q47-interactive .q47-compare-card {
    border-radius: 0.85rem;
    border: 1px solid color-mix(in srgb, var(--color-border-subtle) 70%, transparent 30%);
    background: color-mix(in srgb, var(--color-card) 90%, transparent 10%);
    padding: 0.75rem;
    min-height: 5.25rem;
  }
  html.dark #q47-interactive .q47-compare-card {
    background: color-mix(in srgb, var(--color-card) 70%, transparent 30%);
    border-color: color-mix(in srgb, var(--color-border) 70%, transparent 30%);
  }
  #q47-interactive .q47-compare-card--empty {
    color: var(--color-muted);
    font-style: italic;
  }

  #q47-interactive .q47-trail {
    border-radius: 0.85rem;
    background: color-mix(in srgb, var(--color-card) 88%, transparent 12%);
    border: 1px solid color-mix(in srgb, var(--color-border-subtle) 65%, transparent 35%);
    padding: 0.75rem;
    max-height: 12rem;
    overflow: auto;
  }
  html.dark #q47-interactive .q47-trail {
    background: color-mix(in srgb, var(--color-card) 70%, transparent 30%);
    border-color: color-mix(in srgb, var(--color-border) 70%, transparent 30%);
  }

  .q47-tour-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(15, 23, 42, 0.78);
    z-index: 60;
    font-size: 0.85rem;
    padding: 1.5rem;
  }
  .q47-tour-dialog {
    width: min(380px, 100%);
    border-radius: 1rem;
    padding: 1.1rem;
    background: color-mix(in srgb, var(--color-card) 95%, transparent 5%);
    border: 1px solid color-mix(in srgb, var(--color-border-subtle) 70%, transparent 30%);
    box-shadow: 0 25px 45px rgba(15, 23, 42, 0.35);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  html.dark .q47-tour-dialog {
    background: color-mix(in srgb, var(--color-card) 72%, transparent 28%);
    border-color: color-mix(in srgb, var(--color-border) 70%, transparent 30%);
    box-shadow: 0 25px 45px rgba(2, 6, 23, 0.55);
  }
  .q47-tour-title {
    font-weight: 600;
    color: var(--color-heading);
  }
  .q47-tour-body {
    color: var(--color-body);
    line-height: 1.5;
  }
  .q47-tour-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
  }
  .q47-tour-ctrl {
    border-radius: 9999px;
    padding: 0.35rem 0.9rem;
    font-size: 0.78rem;
    font-weight: 600;
    border: 1px solid color-mix(in srgb, var(--color-border-subtle) 70%, transparent 30%);
    background: color-mix(in srgb, var(--color-card) 92%, transparent 8%);
    color: var(--color-heading);
    transition: background-color .2s ease, color .2s ease, border-color .2s ease, opacity .2s ease;
  }
  html.dark .q47-tour-ctrl {
    background: color-mix(in srgb, var(--color-card) 70%, transparent 30%);
    border-color: color-mix(in srgb, var(--color-border) 70%, transparent 30%);
    color: var(--color-body);
  }
  .q47-tour-ctrl--primary {
    background: var(--color-path-foundations-strong);
    border-color: var(--color-path-foundations-strong);
    color: #fff;
  }
  html.dark .q47-tour-ctrl--primary {
    color: var(--color-heading);
  }
  .q47-tour-ctrl--warn {
    background: color-mix(in srgb, var(--panel-warning-bg) 65%, transparent 35%);
    border-color: var(--panel-warning-border);
    color: var(--panel-warning-heading);
  }
  .q47-tour-ctrl[disabled] {
    opacity: 0.45;
    cursor: not-allowed;
  }
</style>

<div class="space-y-6" id="q47-interactive">
  <!-- Controls & Presets -->
  <div class="question-card space-y-4" data-accent="foundations">
    <div class="flex flex-wrap items-center gap-2 text-xs" role="group" aria-label="Presets">
      <span class="font-semibold text-heading">Presets:</span>
      <button type="button" data-q47-preset="ngram-small" class="chip chip-neutral q47-preset-btn">2-gram tiny</button>
      <button type="button" data-q47-preset="ngram-high" class="chip chip-neutral q47-preset-btn">5-gram high</button>
      <button type="button" data-q47-preset="hmm" class="chip chip-neutral q47-preset-btn">HMM tag</button>
      <button type="button" data-q47-preset="tx-short" class="chip chip-neutral q47-preset-btn">Transformer short</button>
      <button type="button" data-q47-preset="tx-long" class="chip chip-neutral q47-preset-btn">Transformer long</button>
      <button type="button" id="q47-tour-btn" class="chip chip-info">Start tour</button>
    </div>
    <div class="grid md:grid-cols-3 gap-3 text-xs">
      <div class="space-y-1">
        <label class="block text-xs font-semibold text-heading" for="q47-model">Model</label>
        <select id="q47-model" aria-label="Model type" class="field-select field-select--compact w-full">
          <option value="ngram" selected>N-gram</option>
          <option value="hmm">HMM</option>
          <option value="transformer">Transformer</option>
        </select>
      </div>
      <div class="space-y-1">
        <label class="block text-xs font-semibold text-heading" for="q47-n">Context size / N</label>
        <input id="q47-n" aria-label="Context size slider" type="range" min="1" max="10" value="3" class="w-full q47-range">
        <div class="text-xs text-muted">N-gram order or transformer visible tokens</div>
      </div>
      <div class="space-y-1">
        <label class="block text-xs font-semibold text-heading" for="q47-L">Sequence length</label>
        <select id="q47-L" aria-label="Sequence length" class="field-select field-select--compact w-full">
          <option>8</option>
          <option selected>16</option>
          <option>32</option>
          <option>64</option>
        </select>
        <div class="text-xs text-muted">Tokens in sequence</div>
      </div>
    </div>
    <div class="grid md:grid-cols-3 gap-3 text-xs">
      <div class="space-y-1">
        <label class="block text-xs font-semibold text-heading" for="q47-smoothing">Smoothing (n-gram)</label>
        <select id="q47-smoothing" aria-label="N-gram smoothing method" class="field-select field-select--compact w-full">
          <option value="none" selected>None</option>
          <option value="addk">Add-k</option>
          <option value="kneser">Kneser-Ney</option>
        </select>
        <div class="text-xs text-muted">Adjusts sparsity handling</div>
      </div>
      <div class="col-span-2 text-xs text-muted flex items-center">Smoothing only affects n-gram perplexity (illustrative heuristic).</div>
    </div>
    <div class="grid md:grid-cols-3 gap-3 text-xs">
      <div class="space-y-1">
        <label class="block text-xs font-semibold text-heading" for="q47-mem">Memory cap <span id="q47-mem-label" class="font-normal text-muted-soft">(transformer only)</span></label>
        <input id="q47-mem" type="range" min="4" max="64" value="64" aria-label="Memory context cap" class="w-full q47-range">
        <div class="text-xs text-muted">Limits usable tokens. <span id="q47-mem-readout" class="font-medium text-accent"></span></div>
      </div>
      <div class="space-y-1">
        <label class="block text-xs font-semibold text-heading" for="q47-factor">Subword factor</label>
        <select id="q47-factor" aria-label="Subword inflation" class="field-select field-select--compact w-full">
          <option value="1" selected>1.0&times;</option>
          <option value="1.2">1.2&times;</option>
          <option value="1.5">1.5&times;</option>
          <option value="2">2.0&times;</option>
        </select>
        <div class="text-xs text-muted">Approximate tokens per word</div>
      </div>
      <div class="text-xs text-muted flex items-center">Shows scaling pressure (cost ~ L^2).</div>
    </div>
  </div>

  <!-- Impact & Guidance -->
  <div class="question-card space-y-4">
    <div class="grid md:grid-cols-3 gap-4 items-start">
      <div class="space-y-2">
        <div class="text-sm font-medium text-heading">Effective context</div>
        <div id="q47-impact" class="space-y-2" aria-live="polite">
          <span id="q47-impact-badge" class="q47-impact-badge" data-level="neutral"></span>
          <div class="q47-impact-meter" data-level="neutral" role="presentation">
            <div id="q47-meter" class="q47-impact-meter-fill" data-level="neutral" style="width:0%"></div>
          </div>
          <div id="q47-coverage" class="text-xs text-muted"></div>
        </div>
        <div class="text-xs text-muted-soft">Visibility ratio relative to full sequence length.</div>
      </div>
      <div>
        <div class="text-sm font-medium text-success mb-1">Good for</div>
        <ul id="q47-pros" class="list-disc pl-5 text-xs space-y-1" aria-live="polite"></ul>
      </div>
      <div>
        <div class="text-sm font-medium text-danger mb-1">Watch out for</div>
        <ul id="q47-cons" class="list-disc pl-5 text-xs space-y-1" aria-live="polite"></ul>
      </div>
    </div>
  </div>

  <!-- Canvas -->
  <div class="question-card space-y-4">
    <div id="q47-canvas" class="space-y-3"></div>
  </div>

  <!-- Explanation & Guide -->
  <div id="q47-expl" class="panel panel-warning p-4 text-sm" aria-live="polite"></div>
  <div id="q47-guide" class="panel panel-info panel-emphasis p-3 text-xs" aria-live="polite"></div>
  <div id="q47-change" class="text-xs text-muted"></div>
  <div id="q47-prob" class="panel panel-neutral-soft p-3 text-xs" aria-live="polite"></div>

  <!-- Compare Panel -->
  <div class="question-card space-y-3 text-xs" id="q47-compare" aria-live="polite">
    <div class="flex flex-wrap items-center gap-2">
      <span class="font-semibold text-heading">A/B compare</span>
      <button type="button" id="q47-capA" class="chip chip-neutral">Capture A</button>
      <button type="button" id="q47-capB" class="chip chip-neutral">Capture B</button>
      <button type="button" id="q47-clearCmp" class="chip chip-warning">Clear</button>
    </div>
    <div class="grid md:grid-cols-3 gap-3" id="q47-compare-slots"></div>
    <div id="q47-compare-delta" class="text-xs text-muted"></div>
  </div>

  <!-- Model Math Pane -->
  <details id="q47-math" class="panel panel-neutral-soft p-3 text-xs">
    <summary class="cursor-pointer font-semibold text-heading">Model math reference</summary>
    <div class="mt-2 space-y-2">
      <div><span class="font-medium text-accent">Chain rule:</span> $$P(w_{1:T}) = \prod_{t=1}^{T} P(w_t \mid w_{1:t-1})$$</div>
      <div><span class="font-medium text-accent">HMM joint:</span> $$P(w_{1:T}, s_{1:T}) = \prod_{t=1}^{T} P(s_t \mid s_{t-1}) P(w_t \mid s_t)$$</div>
      <div><span class="font-medium text-accent">Attention weight:</span> $$\alpha_{t,j} = rac{e^{(q_t \cdot k_j)/\sqrt{d_k}}}{\sum_{j=1}^{T} e^{(q_t \cdot k_j)/\sqrt{d_k}}}$$</div>
    </div>
  </details>

  <!-- Session Trail -->
  <div id="q47-trail-box" class="question-card space-y-2 text-xs">
    <div class="flex items-center justify-between">
      <span class="font-semibold text-heading">Session trail</span>
      <button type="button" id="q47-clearTrail" class="chip chip-neutral">Clear</button>
    </div>
    <ol id="q47-trail" class="list-decimal ml-5 space-y-1 q47-trail" aria-live="polite"></ol>
  </div>
</div>
