<div class="space-y-6">
            <!-- Controls & Presets -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                <div class="flex flex-wrap items-center gap-2 mb-3 text-xs" role="group" aria-label="Presets">
                    <span class="font-semibold text-gray-700">Presets:</span>
                    <button data-q47-preset="ngram-small" class="px-2 py-0.5 rounded border border-blue-300 bg-white hover:bg-blue-100">2‑gram tiny</button>
                    <button data-q47-preset="ngram-high" class="px-2 py-0.5 rounded border border-blue-300 bg-white hover:bg-blue-100">5‑gram high</button>
                    <button data-q47-preset="hmm" class="px-2 py-0.5 rounded border border-blue-300 bg-white hover:bg-blue-100">HMM tag</button>
                    <button data-q47-preset="tx-short" class="px-2 py-0.5 rounded border border-blue-300 bg-white hover:bg-blue-100">Transformer short</button>
                    <button data-q47-preset="tx-long" class="px-2 py-0.5 rounded border border-blue-300 bg-white hover:bg-blue-100">Transformer long</button>
                    <button id="q47-copy" class="px-2 py-0.5 rounded border border-blue-400 bg-white hover:bg-blue-100 text-blue-700">Copy link</button>
                    <button id="q47-export" class="px-2 py-0.5 rounded border border-blue-400 bg-white hover:bg-blue-100 text-blue-700">Export</button>
                    <button id="q47-tour-btn" class="px-2 py-0.5 rounded border border-indigo-400 bg-indigo-50 hover:bg-indigo-100 text-indigo-700">Start tour</button>
                </div>
                <div class="grid md:grid-cols-3 gap-3 text-xs">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Model</label>
                        <select id="q47-model" aria-label="Model type" class="w-full px-2 py-2 border border-gray-300 rounded">
                            <option value="ngram" selected>N-gram</option>
                            <option value="hmm">HMM</option>
                            <option value="transformer">Transformer</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Context size / N</label>
                        <input id="q47-n" aria-label="Context size slider" type="range" min="1" max="10" value="3" class="w-full">
                        <div class="text-xs text-gray-600">N-gram order or transformer visible tokens</div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Sequence length</label>
                        <select id="q47-L" aria-label="Sequence length" class="w-full px-2 py-2 border border-gray-300 rounded">
                            <option>8</option>
                            <option selected>16</option>
                            <option>32</option>
                            <option>64</option>
                        </select>
                        <div class="text-xs text-gray-600">Tokens in sequence</div>
                    </div>
                </div>
                <div class="mt-3 grid md:grid-cols-3 gap-3 text-xs">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Smoothing (n-gram)</label>
                        <select id="q47-smoothing" aria-label="N-gram smoothing method" class="w-full px-2 py-2 border border-gray-300 rounded">
                            <option value="none" selected>None</option>
                            <option value="addk">Add-k</option>
                            <option value="kneser">Kneser-Ney</option>
                        </select>
                        <div class="text-xs text-gray-600">Adjusts sparsity handling</div>
                    </div>
                    <div class="col-span-2 text-xs text-gray-600 flex items-center">Smoothing only affects n-gram perplexity (illustrative heuristic).</div>
                </div>
                <!-- Advanced levers -->
                <div class="mt-3 grid md:grid-cols-3 gap-3 text-xs">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Memory cap <span id="q47-mem-label" class="text-xs font-normal text-gray-500">(transformer only)</span></label>
                        <input id="q47-mem" type="range" min="4" max="64" value="64" aria-label="Memory context cap" class="w-full" />
                        <div class="text-xs text-gray-600">Limits usable tokens. <span id="q47-mem-readout" class="font-medium text-indigo-700"></span></div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Subword factor</label>
                        <select id="q47-factor" aria-label="Subword inflation" class="w-full px-2 py-2 border border-gray-300 rounded">
                            <option value="1" selected>1.0×</option>
                            <option value="1.2">1.2×</option>
                            <option value="1.5">1.5×</option>
                            <option value="2">2.0×</option>
                        </select>
                        <div class="text-xs text-gray-600">Approx tokens/word</div>
                    </div>
                    <div class="text-xs text-gray-600 flex items-center">Shows scaling pressure (cost ~ L²).</div>
                </div>
            </div>

            <!-- Impact & Guidance -->
            <div class="bg-white p-3 rounded-lg border">
                <div class="grid md:grid-cols-3 gap-4 items-start">
                    <div>
                        <div class="text-sm font-medium text-gray-700 mb-1">Effective context</div>
                        <div id="q47-impact" class="text-xs" aria-live="polite">
                            <span id="q47-impact-badge" class="inline-block px-2 py-0.5 rounded border"></span>
                            <div class="h-2 mt-1 rounded bg-gray-200 overflow-hidden">
                                <div id="q47-meter" class="h-full rounded" style="width:0%"></div>
                            </div>
                            <div id="q47-coverage" class="mt-1 text-xs text-gray-600"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Visibility ratio relative to full sequence length.</div>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-green-700 mb-1">Good for</div>
                        <ul id="q47-pros" class="list-disc pl-5 text-xs text-gray-700 space-y-1" aria-live="polite"></ul>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-red-700 mb-1">Watch out for</div>
                        <ul id="q47-cons" class="list-disc pl-5 text-xs text-gray-700 space-y-1" aria-live="polite"></ul>
                    </div>
                </div>
            </div>

            <!-- Canvas -->
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <div id="q47-canvas" class="space-y-3"></div>
            </div>
            
            <!-- Explanation -->
            <div id="q47-expl" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-900" aria-live="polite"></div>
            <div id="q47-guide" class="text-xs text-indigo-700 border-l-4 border-indigo-300 pl-3" aria-live="polite"></div>
            <div id="q47-change" class="text-xs text-gray-600"></div>
               <!-- Probability walkthrough -->
               <div id="q47-prob" class="mt-2 text-xs text-gray-700 bg-white border border-gray-200 rounded p-3" aria-live="polite"></div>

               <!-- Compare Panel -->
               <div class="mt-4 bg-white border border-indigo-200 rounded p-3 text-xs" id="q47-compare" aria-live="polite">
                   <div class="flex flex-wrap items-center gap-2 mb-2">
                       <span class="font-semibold text-indigo-800">A/B Compare</span>
                       <button id="q47-capA" class="px-2 py-0.5 rounded border border-indigo-300 bg-indigo-50 hover:bg-indigo-100">Capture A</button>
                       <button id="q47-capB" class="px-2 py-0.5 rounded border border-indigo-300 bg-indigo-50 hover:bg-indigo-100">Capture B</button>
                       <button id="q47-clearCmp" class="px-2 py-0.5 rounded border border-red-300 bg-red-50 hover:bg-red-100 text-red-700">Clear</button>
                   </div>
                   <div class="grid md:grid-cols-3 gap-3" id="q47-compare-slots"></div>
                   <div id="q47-compare-delta" class="mt-2 text-xs text-gray-600"></div>
               </div>

                <!-- Model Math Pane -->
                <details id="q47-math" class="mt-4 bg-white border border-gray-200 rounded p-3 text-xs">
                    <summary class="cursor-pointer font-semibold text-gray-700">Model math reference</summary>
                    <div class="mt-2 space-y-2">
                        <div><span class="font-medium text-indigo-700">Chain rule:</span> $$P(w_{1:T}) = prod_{t=1}^T P(w_t mid w_{1:t-1})$$</div>
                        <div><span class="font-medium text-indigo-700">HMM joint:</span> $$P(w_{1:T}, s_{1:T}) = prod_{t=1}^T P(s_t mid s_{t-1}) P(w_t mid s_t)$$</div>
                        <div><span class="font-medium text-indigo-700">Attention weight:</span> $$alpha_{t,j} = rac{e^{(q_t cdot k_j)/sqrt{d_k}}}{sum_{j=1}^T e^{(q_t cdot k_j)/sqrt{d_k}}}$$</div>
                    </div>
                </details>


                <!-- Session Trail -->
                <div id="q47-trail-box" class="mt-4 bg-white border border-gray-200 rounded p-3 text-xs">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-gray-700">Session trail</span>
                        <div class="space-x-1">
                            <button id="q47-clearTrail" class="px-2 py-0.5 rounded border border-gray-300 bg-gray-50 hover:bg-gray-100">Clear</button>
                            <button id="q47-exportTrail" class="px-2 py-0.5 rounded border border-indigo-300 bg-indigo-50 hover:bg-indigo-100">Export trail</button>
                        </div>
                    </div>
                    <ol id="q47-trail" class="list-decimal ml-5 space-y-1 max-h-40 overflow-auto" aria-live="polite"></ol>
                </div>
        </div>
